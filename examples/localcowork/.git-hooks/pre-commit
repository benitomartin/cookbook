#!/usr/bin/env bash
# ─────────────────────────────────────────────────────────────────────────────
# LocalCowork — Pre-Commit Hook (Progress + Doc-Sync Guardrail)
# ─────────────────────────────────────────────────────────────────────────────
#
# PURPOSE: Nudges the developer (or Claude Code) when source files changed
# but related documentation was not updated. SOFT warnings only — never
# blocks the commit. Catches forgotten checkpoints and doc drift.
#
# INSTALL:
#   Option A (symlink):  ln -sf ../../.git-hooks/pre-commit .git/hooks/pre-commit
#   Option B (git config): git config core.hooksPath .git-hooks
#
# The setup-dev.sh script handles this automatically.
# ─────────────────────────────────────────────────────────────────────────────

set -euo pipefail

YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

STAGED_FILES=$(git diff --cached --name-only 2>/dev/null || true)

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

WARNINGS=()

# ── Check 1: Source files changed but PROGRESS.yaml not staged ──────────────

HAS_SOURCE_CHANGES=false
for file in $STAGED_FILES; do
    case "$file" in
        src-tauri/src/*|src/*|mcp-servers/*/src/*|_shared/*)
            HAS_SOURCE_CHANGES=true
            break
            ;;
    esac
done

if [ "$HAS_SOURCE_CHANGES" = true ]; then
    if ! echo "$STAGED_FILES" | grep -q "^PROGRESS.yaml$"; then
        WARNINGS+=("PROGRESS.yaml was not updated (source files changed)")
    fi
fi

# ── Check 2: MCP tool files changed but registry not updated ────────────────

HAS_TOOL_CHANGES=false
for file in $STAGED_FILES; do
    case "$file" in
        mcp-servers/*/src/tools/*)
            HAS_TOOL_CHANGES=true
            break
            ;;
    esac
done

if [ "$HAS_TOOL_CHANGES" = true ]; then
    if ! echo "$STAGED_FILES" | grep -q "docs/mcp-tool-registry.yaml"; then
        WARNINGS+=("MCP tool files changed but docs/mcp-tool-registry.yaml was not updated")
    fi
fi

# ── Check 3: New tool file without a corresponding test file ────────────────

for file in $STAGED_FILES; do
    case "$file" in
        mcp-servers/*/src/tools/*.ts)
            TOOL_NAME=$(basename "$file" .ts)
            SERVER_DIR=$(echo "$file" | cut -d'/' -f1-2)
            if ! echo "$STAGED_FILES" | grep -q "${SERVER_DIR}/tests/${TOOL_NAME}"; then
                if ! echo "$STAGED_FILES" | grep -q "${SERVER_DIR}/tests/.*${TOOL_NAME}"; then
                    WARNINGS+=("New tool ${TOOL_NAME} has no test file staged")
                fi
            fi
            ;;
        mcp-servers/*/src/tools/*.py)
            TOOL_NAME=$(basename "$file" .py)
            SERVER_DIR=$(echo "$file" | cut -d'/' -f1-2)
            if ! echo "$STAGED_FILES" | grep -q "${SERVER_DIR}/tests/.*${TOOL_NAME}"; then
                WARNINGS+=("New tool ${TOOL_NAME} has no test file staged")
            fi
            ;;
    esac
done

# ── Check 4: Breaking change surfaces modified without an ADR ───────────────
# Surfaces: shared services, model abstraction, audit log schema, HITL flow

HAS_BREAKING_CHANGES=false
BREAKING_DETAIL=""
for file in $STAGED_FILES; do
    case "$file" in
        _shared/services/*)
            HAS_BREAKING_CHANGES=true
            BREAKING_DETAIL="Shared services"
            break
            ;;
        src-tauri/src/inference/*)
            HAS_BREAKING_CHANGES=true
            BREAKING_DETAIL="Model abstraction layer"
            break
            ;;
        src-tauri/src/agent_core/audit*)
            HAS_BREAKING_CHANGES=true
            BREAKING_DETAIL="Audit log schema"
            break
            ;;
    esac
done

if [ "$HAS_BREAKING_CHANGES" = true ]; then
    if ! echo "$STAGED_FILES" | grep -q "docs/architecture-decisions/"; then
        WARNINGS+=("${BREAKING_DETAIL} changed — an ADR may be required (see CLAUDE.md Breaking Changes)")
    fi
fi

# ── Check 5: Agent Core changed without pattern doc updates ─────────────────

HAS_AGENT_CORE_CHANGES=false
for file in $STAGED_FILES; do
    case "$file" in
        src-tauri/src/agent_core/*)
            HAS_AGENT_CORE_CHANGES=true
            break
            ;;
    esac
done

if [ "$HAS_AGENT_CORE_CHANGES" = true ]; then
    if ! echo "$STAGED_FILES" | grep -q "docs/patterns/"; then
        WARNINGS+=("Agent Core changed but no pattern docs were updated")
    fi
fi

# ── Check 6: Deleted or renamed files still referenced in docs ──────────────

for file in $(git diff --cached --diff-filter=DR --name-only 2>/dev/null || true); do
    # Only check source and doc files, not generated or binary
    case "$file" in
        *.ts|*.py|*.rs|*.md|*.yaml|*.yml|*.sh)
            BASENAME=$(basename "$file")
            # Quick check: does any doc mention this filename?
            if grep -rlq "$BASENAME" docs/ CLAUDE.md README.md .claude/ PROGRESS.yaml 2>/dev/null; then
                WARNINGS+=("Deleted/renamed file '${file}' is still referenced in docs — run: grep -r '${BASENAME}' docs/ CLAUDE.md")
            fi
            ;;
    esac
done

# ── Output warnings ────────────────────────────────────────────────────────

if [ ${#WARNINGS[@]} -gt 0 ]; then
    echo ""
    echo -e "${YELLOW}═══════════════════════════════════════════════════${NC}"
    echo -e "${YELLOW}  Doc-Sync Warnings (${#WARNINGS[@]} found)${NC}"
    echo -e "${YELLOW}═══════════════════════════════════════════════════${NC}"
    echo ""
    for warning in "${WARNINGS[@]}"; do
        echo -e "  ${CYAN}→${NC} $warning"
    done
    echo ""
    echo "  These are reminders, not blockers. The commit will proceed."
    echo "  See .claude/skills/feature-dev/SKILL.md for the full doc-sync checklist."
    echo ""
fi

# Always allow the commit (soft warnings only)
exit 0
